#!/bin/sh
#
# Pre-commit hook that runs tests before allowing commits
#
# To install this hook, run:
#   git config core.hooksPath .githooks
#

# Skip hooks in CI environments
if [ -n "$GITHUB_ACTIONS" ] || [ -n "$CI" ]; then
    exit 0
fi

echo "ğŸ§ª Running pre-commit tests..."

# Change to repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# Check if any JavaScript files in .github/scripts have been modified
SCRIPTS_CHANGED=$(git diff --cached --name-only | grep -E "\.github/scripts/.*\.js$")
WORKFLOWS_CHANGED=$(git diff --cached --name-only | grep -E "\.github/workflows/.*\.ya?ml$")
README_CHANGED=$(git diff --cached --name-only | grep "README.md")

# Run appropriate tests based on what changed
if [ -n "$SCRIPTS_CHANGED" ] || [ -n "$WORKFLOWS_CHANGED" ] || [ -n "$README_CHANGED" ]; then
    echo "ğŸ“‹ Detected changes in scripts, workflows, or README"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # Check if Node.js is available
    if ! command -v node >/dev/null 2>&1; then
        echo "âš ï¸  Node.js not found - skipping tests"
        echo "ğŸ’¡ Install Node.js to run pre-commit tests"
        exit 0
    fi
    
    # Install dependencies if needed
    if [ ! -d ".github/test/node_modules" ]; then
        echo "ğŸ“¦ Installing test dependencies..."
        (cd .github/test && npm install --silent) || {
            echo "âš ï¸  Failed to install test dependencies - skipping tests"
            exit 0
        }
    fi
    
    # Run tests
    node .github/test/run-all-tests.js
    TEST_RESULT=$?
    
    if [ $TEST_RESULT -ne 0 ]; then
        echo ""
        echo "âŒ Tests failed! Please fix the issues before committing."
        echo "ğŸ’¡ Tip: Run 'node .github/test/run-all-tests.js' to see detailed results"
        exit 1
    fi
    
    echo ""
    echo "âœ… All tests passed!"
else
    echo "â„¹ï¸  No changes to scripts, workflows, or README - skipping tests"
fi

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âœ¨ Pre-commit checks completed successfully"